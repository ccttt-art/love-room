<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>COUPLE MATRIX</title>

<style>
body{
    margin:0;
    font-family:"Segoe UI",sans-serif;
    background:#fff;
    color:#111;
}

header{
    background:#000;
    color:#fff;
    text-align:center;
    padding:20px;
    letter-spacing:3px;
}

.top-bar{
    text-align:center;
    padding:15px;
}

select,input{
    padding:6px;
    margin:5px;
}

button{
    background:#111;
    color:#fff;
    border:none;
    padding:6px 12px;
    cursor:pointer;
}

.grid{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    grid-template-rows:repeat(3,180px);
    gap:15px;
    padding:30px;
}

.card{
    background:#f5f5f5;
    border-radius:12px;
    padding:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    overflow:auto;
}

.center{
    background:#111;
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:bold;
    font-size:16px;
}

.small{
    font-size:13px;
}

.completed{
    text-decoration:line-through;
    color:#aaa;
}
</style>
</head>

<body>

<header>COUPLE GROWTH MATRIX</header>

<div class="top-bar">
<select id="userSelect">
<option value="我">我</option>
<option value="他">他</option>
</select>

<input type="text" id="centerInput" placeholder="中央目標">
<input type="number" id="positionInput" min="1" max="8" placeholder="位置1-8">
<input type="text" id="actionInput" placeholder="小目標內容">

<select id="typeInput">
<option value="daily">daily</option>
<option value="weekly">weekly</option>
</select>

<button onclick="addGoal()">新增</button>
</div>

<div class="grid" id="grid"></div>

<script>

const API_URL="https://script.google.com/macros/s/AKfycbx8jEx6Jslxzt50H5dhNNLW_olHg4p8zbJa_2En65ZwJJ5rNEkcn20vDIJ-kvKEb5Se0g/exec";
let allData=[];

async function loadData(){
    const res=await fetch(API_URL);
    allData=await res.json();
    render();
}

function render(){
    const grid=document.getElementById("grid");
    grid.innerHTML="";

    const user=document.getElementById("userSelect").value;
    const centerGoal=document.getElementById("centerInput").value;

    for(let i=1;i<=9;i++){
        const card=document.createElement("div");
        card.className="card";

        if(i===5){
            card.classList.add("center");
            card.innerText=centerGoal || "中央目標";
        }else{
            const positionMap=[1,2,3,4,6,7,8,9];
            const pos=positionMap[i>5?i-2:i-1];

            const item=allData.find(g=>
                g.User===user &&
                g.CenterGoal===centerGoal &&
                g.Position==pos
            );

            if(item){
                card.innerHTML=`
                <div class="small ${item.Completed===true||item.Completed==="TRUE"?"completed":""}">
                ${item.Action}<br>
                (${item.Type})
                <br><br>
                <button onclick="toggleGoal('${user}','${centerGoal}',${pos},${item.Completed})">
                ${item.Completed===true||item.Completed==="TRUE"?"✓":"完成"}
                </button>
                </div>
                `;
            }
        }

        grid.appendChild(card);
    }
}

async function addGoal(){
    const user=document.getElementById("userSelect").value;
    const centerGoal=document.getElementById("centerInput").value;
    const position=document.getElementById("positionInput").value;
    const actionText=document.getElementById("actionInput").value;
    const type=document.getElementById("typeInput").value;

    if(!centerGoal||!position||!actionText) return;

    await fetch(API_URL,{
        method:"POST",
        body:JSON.stringify({
            action:"add",
            user:user,
            centerGoal:centerGoal,
            position:position,
            actionText:actionText,
            type:type
        })
    });

    loadData();
}

async function toggleGoal(user,centerGoal,position,current){
    await fetch(API_URL,{
        method:"POST",
        body:JSON.stringify({
            action:"toggle",
            user:user,
            centerGoal:centerGoal,
            position:position,
            completed: !(current===true||current==="TRUE")
        })
    });
    loadData();
}

loadData();

</script>

</body>
</html>
